package com.campusconnect.servlets;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.*;

import com.campusconnect.dao.NotesDao;
import com.campusconnect.model.Notes;

@MultipartConfig
@WebServlet("/uploadNote")
public class UploadNoteServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        HttpSession session = request.getSession(false);
        String role = (session != null) ? (String) session.getAttribute("role") : null;

        if (!"admin".equals(role)) {
            response.sendError(HttpServletResponse.SC_FORBIDDEN, "Access Denied");
            return;
        }

        String title = request.getParameter("title");
        Part filePart = request.getPart("file");

        if (title == null || title.isEmpty() || filePart == null) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST, "Missing required parameters.");
            return;
        }

        // Extract filename manually (for Servlet 3.0 compatibility)
        String contentDisp = filePart.getHeader("content-disposition");
        String fileName = contentDisp.substring(contentDisp.indexOf("filename=") + 10).replace("\"", "");
        if (fileName == null || fileName.isEmpty()) {
            response.sendError(HttpServletResponse.SC_BAD_REQUEST, "File is missing.");
            return;
        }

        // Save file to /uploads folder
        String uploadPath = getServletContext().getRealPath("") + File.separator + "uploads";
        fileName = new File(fileName).getName(); // Normalize filename
        File uploadDir = new File(uploadPath);
        if (!uploadDir.exists()) uploadDir.mkdir();

        String filePath = uploadPath + File.separator + fileName;
        try (InputStream is = filePart.getInputStream();
             FileOutputStream fos = new FileOutputStream(filePath)) {
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                fos.write(buffer, 0, len);
            }
        }

        // Save to database
        Notes note = new Notes();
        note.setTitle(title);
        note.setFilePath("uploads/" + fileName);

        NotesDao dao = new NotesDao();
        boolean success = dao.addNote(note);

        response.sendRedirect("viewNotes?status=" + (success ? "success" : "error"));
    }
}
